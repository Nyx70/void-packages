# Template file for 'grass'
pkgname=grass
version=8.2.0
revision=1
_binver=${version%.*}
_binver=${_binver//./}
build_style=gnu-configure
configure_args="--prefix=/usr/lib --bindir=/usr/bin
 --with-regex --with-freetype-includes=${XBPS_CROSS_BASE}/usr/include/freetype2
 $(vopt_with bzip2 bzlib)
 $(vopt_with geos)
 $(vopt_with mysql) $(vopt_if mysql --with-mysql-includes=/usr/include/mysql)
 $(vopt_with nls)
 $(vopt_with pthread)
 $(vopt_with postgres)"
hostmakedepends="flex libgdal-tools pkg-config python3-numpy python3-six tar
 $(vopt_if nls gettext)"
makedepends="proj-devel tiff-devel libgdal-devel sqlite-devel fftw-devel
 cairo-devel glu-devel wxPython-devel libzstd-devel bzip2-devel
 $(vopt_if bzip2 bzip2-devel)
 $(vopt_if geos geos-devel)
 $(vopt_if mysql libmysqlclient-devel)
 $(vopt_if nls gettext-devel)
 $(vopt_if postgres postgresql-libs-devel)"
depends="python3-numpy wxPython4 libgdal>=3.2.0_1"
short_desc="Geographic Resources Analysis Support System"
#maintainer="Alex Jarosch <research@alexj.at>"
maintainer="Nyx70 <n.y.x@bluewin.ch>"
license="GPL-2.0-or-later"
homepage="https://grass.osgeo.org/"
distfiles="https://github.com/OSGeo/grass/archive/${version}.tar.gz"
checksum=621c3304a563be19c0220ae28f931a5e9ba74a53218c5556cd3f7fbfcca33a80
nocross="tries to execute target binaries"

build_options="geos mysql nls pthread postgres"
build_options_default="pthread"

shlib_provides="libgrass_dbmibase.${version%.*}.so libgrass_dbmiclient.${version%.*}.so
 libgrass_gis.${version%.*}.so libgrass_gproj.${version%.*}.so libgrass_imagery.${version%.*}.so
 libgrass_raster.${version%.*}.so libgrass_vector.${version%.*}.so"

post_install() {
	# ld.so.conf
	mkdir -p ${DESTDIR}/etc/ld.so.conf.d
	echo "/usr/lib/grass${_binver}/lib" >${DESTDIR}/etc/ld.so.conf.d/grass${_binver}.conf
	# profiles
	mkdir -p ${DESTDIR}/etc/profile.d
	echo 'export PATH="/usr/lib/grass'${_binver}'/bin:$PATH"' >${DESTDIR}/etc/profile.d/grass${_binver}.sh

	# install .pc file
	vinstall grass.pc 0644 usr/share/pkgconfig

	# desktop entry
	vinstall dist.x86_64-unknown-linux-gnu/share/applications/grass.desktop 644 usr/share/applications

	# icons
	local icon res
	for icon in gui/icons/grass-[0-9]*x[0-9]*.png; do
		res=$(echo $icon |sed -E -e 's|.*-([0-9]+x[0-9]+).png|\1|')
		vinstall $icon 0644 /usr/share/icons/hicolor/$res/apps grass.png
	done
}
